name: youtube
on:
  workflow_dispatch:
    inputs:
      url:
        description: 'video url'
        required: true
        default: ''
      name:
        description: 'video name'
        required: true
        default: ''
      quality:
        description: 'video quality'
        required: false
        default: 720
        type: choice
        options:
          - 360
          - 480
          - 720
          - 1080
          - 1440
          - 2160
          - 4320
      fps:
        description: 'video fps'
        required: false
        default: 30
        type: choice
        options:
          - 15
          - 25
          - 30
          - 60

jobs:
  vedio:
    runs-on: ubuntu-latest
    env:
      go: '1.17'

    steps:
    - name: Use Go ${{ env.go }}
      uses: actions/setup-go@v3
      with:
        go-version: ${{ env.go }}

    - name: Checkout
      timeout-minutes: 1
      uses: actions/checkout@v3
      with:
        persist-credentials: false

    - name: Downalod
      run: |
        make -C golang youtube
        golang/youtube -name $NAME -url $URL -quality $QUALITY -fps $FPS
      env:
        NAME: ${{github.workspace}}/${{github.event.inputs.name}}
        URL: ${{github.event.inputs.url}}
        QUALITY: ${{github.event.inputs.quality}}
        FPS: ${{github.event.inputs.fps}}

    - name: Convert
      if: ${{ success() }}
      run: |
        cd ${{github.workspace}}
        name=$(ls|grep $NAME)
        echo "ext: ${name##*.}"
        if [[ "${name##*.}" != "mp4" ]]; then
          wget --quiet  https://github.com/tiechui1994/actions/releases/download/ffmpeg_5.1/ffmpeg.tar.xz -O ffmpeg.tar.xz
          tar xf ffmpeg.tar.xz && chmod a+x ffmpeg/ffmpeg
          name=$(ls|grep $NAME)
          ffmpeg/ffmpeg -i "$name" -crf 20 -c:v libx264 "${NAME}.mp4"
        fi
        ls -lh
      env:
        NAME: ${{github.event.inputs.name}}
        
    - name: Upload
      if: ${{ success() }}
      run: |
        make -C golang upload
        golang/upload -upload -file "${NAME}.mp4"
      env:
        ALIDRIVE_TOKEN: ${{secrets.ALIDRIVE_TOKEN}}
        NAME: ${{github.workspace}}/${{github.event.inputs.name}}

